<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Alex's Gym Tracker</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

:root {
  --bg:       #0f0f0f;
  --card:     #1c1c1e;
  --card2:    #2c2c2e;
  --accent:   #ff3b30;
  --green:    #30d158;
  --text:     #f2f2f7;
  --sub:      #8e8e93;
  --border:   #3a3a3c;
  --radius:   14px;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
  min-height: 100vh;
  padding-bottom: 80px;
}

/* â”€â”€ Sign-in screen â”€â”€ */
#signin-screen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 40px 24px;
  text-align: center;
}
.signin-logo { font-size: 64px; margin-bottom: 24px; }
.signin-title { font-size: 32px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 8px; }
.signin-sub { font-size: 16px; color: var(--sub); margin-bottom: 48px; line-height: 1.5; }
.signin-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  background: #fff;
  color: #111;
  border: none;
  border-radius: 14px;
  padding: 16px 28px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  max-width: 320px;
  justify-content: center;
}
.signin-btn:active { opacity: 0.8; }
.signin-btn svg { width: 20px; height: 20px; flex-shrink: 0; }

/* â”€â”€ Loading screen â”€â”€ */
#loading-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  gap: 16px;
  color: var(--sub);
  font-size: 14px;
}
.spinner {
  width: 32px; height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ App â”€â”€ */
#app { display: none; }

/* â”€â”€ Header â”€â”€ */
.header {
  background: rgba(15,15,15,0.92);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 52px 20px 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  border-bottom: 1px solid var(--border);
}
.header-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}
.header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
.header .date { font-size: 13px; color: var(--sub); margin-top: 2px; }
.header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
.workout-badge {
  background: var(--accent);
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 20px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.signout-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--sub);
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 20px;
  cursor: pointer;
}

/* â”€â”€ Nav â”€â”€ */
.nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: rgba(28,28,30,0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 100;
}
.nav-btn {
  flex: 1;
  padding: 12px 0 20px;
  border: none;
  background: none;
  color: var(--sub);
  font-size: 10px;
  letter-spacing: 0.3px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  transition: color 0.15s;
}
.nav-btn.active { color: var(--accent); }
.nav-btn svg { width:22px; height:22px; }

/* â”€â”€ Views â”€â”€ */
.view { display: none; padding: 16px; }
.view.active { display: block; }

/* â”€â”€ Rest day â”€â”€ */
.rest-screen {
  text-align: center;
  padding: 60px 20px;
}
.rest-screen .emoji { font-size: 64px; margin-bottom: 16px; }
.rest-screen h2 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
.rest-screen p { color: var(--sub); font-size: 16px; line-height: 1.5; }

/* â”€â”€ Summary bar â”€â”€ */
.summary-bar {
  background: var(--card);
  border-radius: var(--radius);
  padding: 14px 16px;
  margin-bottom: 16px;
  display: flex;
}
.summary-stat { flex: 1; text-align: center; }
.summary-stat + .summary-stat { border-left: 1px solid var(--border); }
.summary-stat .val { font-size: 20px; font-weight: 700; }
.summary-stat .lbl { font-size: 11px; color: var(--sub); margin-top: 2px; }

/* â”€â”€ Exercise card â”€â”€ */
.exercise-card {
  background: var(--card);
  border-radius: var(--radius);
  margin-bottom: 16px;
  overflow: hidden;
}
.exercise-img {
  width: 100%; height: 180px;
  object-fit: cover; display: block;
  background: var(--card2);
  cursor: zoom-in;
}

/* â”€â”€ Lightbox â”€â”€ */
#lightbox {
  display: none;
  position: fixed; inset: 0; z-index: 999;
  background: rgba(0,0,0,0.92);
  align-items: center; justify-content: center;
  padding: 24px;
}
#lightbox.open { display: flex; }
#lightbox img {
  max-width: 100%; max-height: 100%;
  object-fit: contain;
  border-radius: 10px;
}
.exercise-img-placeholder {
  width: 100%; height: 180px;
  background: var(--card2);
  display: flex; align-items: center; justify-content: center;
  font-size: 48px; color: var(--sub);
}
.exercise-body { padding: 14px 16px; }
.exercise-header {
  display: flex; justify-content: space-between;
  align-items: flex-start; margin-bottom: 6px;
}
.exercise-name { font-size: 17px; font-weight: 700; line-height: 1.2; flex: 1; }
.muscle-badge {
  background: var(--card2); color: var(--sub);
  font-size: 10px; font-weight: 600;
  padding: 3px 8px; border-radius: 20px;
  margin-left: 8px; white-space: nowrap;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.exercise-meta {
  display: flex; gap: 12px; margin-bottom: 14px; flex-wrap: wrap;
}
.meta-chip {
  font-size: 12px; color: var(--sub);
  background: var(--card2); padding: 3px 9px; border-radius: 8px;
}
.meta-chip span { color: var(--text); font-weight: 600; }
.prev-best {
  font-size: 12px; color: var(--sub);
  margin-bottom: 12px; display: flex; align-items: center; gap: 5px;
}
.prev-best .val { color: var(--green); font-weight: 700; }

/* â”€â”€ Day selector â”€â”€ */
.day-selector {
  display: flex; gap: 8px;
  padding: 10px 20px 12px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.day-selector::-webkit-scrollbar { display: none; }
.day-pill {
  flex-shrink: 0;
  display: flex; flex-direction: column; align-items: center;
  padding: 6px 14px;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  background: none; color: var(--sub);
  font-size: 13px; font-weight: 600;
  cursor: pointer; white-space: nowrap; line-height: 1.3;
  transition: all 0.15s;
}
.day-pill small { font-size: 9px; font-weight: 400; letter-spacing: 0.5px; text-transform: uppercase; }
.day-pill.is-today { border-color: var(--text); color: var(--text); }
.day-pill.selected { background: var(--accent); border-color: var(--accent); color: #fff; }

/* â”€â”€ Set logger â”€â”€ */
.sets-header {
  display: grid; grid-template-columns: 36px 1fr 1fr 36px 28px;
  gap: 6px; margin-bottom: 6px; padding: 0 2px;
}
.sets-header span {
  font-size: 11px; color: var(--sub); text-align: center;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.sets-header span:first-child { text-align: left; }
.set-row {
  display: grid; grid-template-columns: 36px 1fr 1fr 36px 28px;
  gap: 6px; margin-bottom: 6px; align-items: center;
}
.set-del-btn {
  width: 28px; height: 28px;
  border-radius: 50%; border: none;
  background: none; color: var(--border);
  font-size: 18px; line-height: 1;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; padding: 0; transition: color 0.15s;
}
.set-del-btn:active { color: var(--accent); }
.set-num { font-size: 13px; color: var(--sub); font-weight: 600; padding-top: 2px; }
.set-input {
  background: var(--card2); border: 1.5px solid var(--border);
  border-radius: 10px; color: var(--text);
  font-size: 16px; font-weight: 600; padding: 8px 10px;
  text-align: center; width: 100%; -webkit-appearance: none; outline: none;
  transition: border-color 0.15s;
}
.set-input:focus { border-color: var(--accent); }
.set-input::placeholder { color: var(--border); font-weight: 400; font-size: 14px; }
.set-done-btn {
  width: 36px; height: 36px; border-radius: 50%;
  border: 1.5px solid var(--border); background: none;
  color: var(--sub); font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.15s;
}
.set-done-btn.logged { background: var(--green); border-color: var(--green); color: #fff; }
.add-set-btn {
  width: 100%; margin-top: 6px; padding: 8px;
  background: none; border: 1.5px dashed var(--border);
  border-radius: 10px; color: var(--sub); font-size: 13px; cursor: pointer;
}
.add-set-btn:active { opacity: 0.6; }

/* â”€â”€ Progress bar â”€â”€ */
.progress-bar-wrap { margin-top: 10px; }
.progress-bar-label {
  display: flex; justify-content: space-between;
  font-size: 11px; color: var(--sub); margin-bottom: 4px;
}
.progress-bar-track {
  height: 4px; background: var(--card2); border-radius: 4px; overflow: hidden;
}
.progress-bar-fill {
  height: 100%; background: var(--green); border-radius: 4px; transition: width 0.3s ease;
}

/* â”€â”€ History â”€â”€ */
.history-empty { text-align: center; padding: 60px 20px; color: var(--sub); }
.history-empty .emoji { font-size: 48px; margin-bottom: 12px; }
.session-group { margin-bottom: 24px; }
.session-date {
  font-size: 13px; color: var(--sub); font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; padding: 0 4px;
}
.session-card { background: var(--card); border-radius: var(--radius); margin-bottom: 10px; overflow: hidden; }
.session-card-header {
  padding: 12px 14px; display: flex; justify-content: space-between;
  align-items: center; cursor: pointer;
}
.session-card-header h3 { font-size: 15px; font-weight: 700; }
.session-card-header .session-summary { font-size: 12px; color: var(--sub); margin-top: 2px; }
.session-chevron { color: var(--sub); font-size: 12px; transition: transform 0.2s; }
.session-chevron.open { transform: rotate(90deg); }
.session-detail { display: none; padding: 0 14px 12px; }
.session-detail.open { display: block; }
.session-exercise { margin-bottom: 10px; }
.session-exercise-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
.session-set-row { font-size: 12px; color: var(--sub); display: flex; gap: 8px; }
.session-set-row .set-label { color: var(--sub); min-width: 36px; }
.session-set-row .set-data { color: var(--text); font-weight: 600; }

/* â”€â”€ Sync indicator â”€â”€ */
.sync-toast {
  position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
  background: var(--card2); color: var(--sub); font-size: 12px;
  padding: 6px 14px; border-radius: 20px; opacity: 0;
  transition: opacity 0.3s; pointer-events: none; white-space: nowrap;
  z-index: 200;
}
.sync-toast.show { opacity: 1; }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-screen">
  <div class="spinner"></div>
  <span>Loading...</span>
</div>

<!-- Sign-in -->
<div id="signin-screen">
  <div class="signin-logo">ğŸ‹ï¸</div>
  <div class="signin-title">Gym Tracker</div>
  <div class="signin-sub">Sign in to sync your workouts<br>across all your devices</div>
  <button class="signin-btn" onclick="signIn()">
    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
    Sign in with Google
  </button>
</div>

<!-- App -->
<div id="app">
  <div class="header">
    <div class="header-top">
      <div>
        <h1 id="workoutTitle">Loading...</h1>
        <div class="date" id="todayDate"></div>
      </div>
      <div class="header-right">
        <div class="workout-badge" id="workoutBadge"></div>
        <button class="signout-btn" onclick="signOut()">Sign out</button>
      </div>
    </div>
    <div class="day-selector" id="daySelector"></div>
  </div>

  <div class="view active" id="view-today">
    <div id="todayContent"></div>
  </div>

  <div class="view" id="view-history">
    <div id="historyContent"></div>
  </div>

  <nav class="nav">
    <button class="nav-btn active" id="nav-today" onclick="switchTab('today')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      Today
    </button>
    <button class="nav-btn" id="nav-history" onclick="switchTab('history')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      History
    </button>
  </nav>
</div>

<div class="sync-toast" id="syncToast">Synced to cloud â˜ï¸</div>
<div id="lightbox" onclick="this.classList.remove('open')"><img id="lightbox-img" src="" alt=""></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// â”€â”€ Firebase init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyAYtk7UfmaPH60MYuP-N85R1gUUzgDCdH8",
  authDomain: "gym-tracker-6af15.firebaseapp.com",
  projectId: "gym-tracker-6af15",
  storageBucket: "gym-tracker-6af15.firebasestorage.app",
  messagingSenderId: "1081521474087",
  appId: "1:1081521474097:web:8dfeba681072f15bc3dc02"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

// â”€â”€ Workout data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WORKOUTS = {
  1: {
    name: 'Upper A', focus: 'Strength',
    exercises: [
      { name: 'Barbell Bench Press',  muscle: 'Chest',     sets: 4, reps: '6-8',   tempo: '3-0-1-0', rest: '30 sec', imgId: 'Barbell_Bench_Press_-_Medium_Grip/0.jpg' },
      { name: 'Barbell Rows',         muscle: 'Back',      sets: 4, reps: '6-8',   tempo: '3-0-1-0', rest: '30 sec', imgId: 'Bent_Over_Barbell_Row/0.jpg' },
      { name: 'Overhead Press',       muscle: 'Shoulders', sets: 3, reps: '6-8',   tempo: '3-0-1-0', rest: '30 sec', imgId: 'Barbell_Shoulder_Press/0.jpg' },
      { name: 'Pull-ups',             muscle: 'Back',      sets: 3, reps: '6-8',   tempo: '3-0-1-0', rest: '30 sec', imgId: 'Pullups/0.jpg' },
      { name: 'Barbell Curl',         muscle: 'Biceps',    sets: 3, reps: '8-10',  tempo: '3-0-1-0', rest: '30 sec', imgId: 'Barbell_Curl/0.jpg' },
      { name: 'Skull Crushers',       muscle: 'Triceps',   sets: 3, reps: '8-10',  tempo: '3-0-1-0', rest: '30 sec', imgId: 'Decline_Close-Grip_Bench_To_Skull_Crusher/0.jpg' },
    ]
  },
  2: {
    name: 'Lower A', focus: 'Strength',
    exercises: [
      { name: 'Barbell Squat',        muscle: 'Quads',      sets: 4, reps: '6-8',   tempo: '3-0-1-0', rest: '30 sec', imgId: 'Barbell_Squat/0.jpg' },
      { name: 'Romanian Deadlift',    muscle: 'Hamstrings', sets: 4, reps: '6-8',   tempo: '3-0-1-0', rest: '30 sec', imgId: 'Romanian_Deadlift/0.jpg' },
      { name: 'Leg Press',            muscle: 'Quads',      sets: 3, reps: '8-10',  tempo: '3-0-1-0', rest: '30 sec', imgId: 'Leg_Press/0.jpg' },
      { name: 'Walking Lunges',       muscle: 'Glutes',     sets: 3, reps: '10-12', tempo: '2-0-1-0', rest: '30 sec', imgId: 'Barbell_Walking_Lunge/0.jpg' },
      { name: 'Calf Raises',          muscle: 'Calves',     sets: 4, reps: '12-15', tempo: '2-1-1-1', rest: '30 sec', imgId: 'Standing_Calf_Raises/0.jpg' },
      { name: 'Plank',                muscle: 'Core',       sets: 3, reps: '45s',   tempo: '-',       rest: '30 sec', imgId: 'Plank/0.jpg' },
    ]
  },
  4: {
    name: 'Upper B', focus: 'Hypertrophy',
    exercises: [
      { name: 'Incline Dumbbell Press',  muscle: 'Chest',     sets: 4, reps: '10-12', tempo: '3-0-1-0', rest: '30 sec', imgId: 'Incline_Dumbbell_Press/0.jpg' },
      { name: 'Lat Pulldown',            muscle: 'Back',      sets: 4, reps: '10-12', tempo: '3-0-1-0', rest: '30 sec', imgId: 'Close-Grip_Front_Lat_Pulldown/0.jpg' },
      { name: 'Dumbbell Shoulder Press', muscle: 'Shoulders', sets: 3, reps: '10-12', tempo: '3-0-1-0', rest: '30 sec', imgId: 'Dumbbell_Shoulder_Press/0.jpg' },
      { name: 'Dumbbell Flyes',          muscle: 'Chest',     sets: 3, reps: '12-15', tempo: '3-0-1-0', rest: '30 sec', imgId: 'Decline_Dumbbell_Flyes/0.jpg' },
      { name: 'Face Pulls',              muscle: 'Rear Delt', sets: 3, reps: '15-20', tempo: '2-1-1-0', rest: '30 sec', imgId: 'Face_Pull/0.jpg' },
      { name: 'Hammer Curls',            muscle: 'Biceps',    sets: 3, reps: '12-15', tempo: '3-0-1-0', rest: '30 sec', imgId: 'Alternate_Hammer_Curl/0.jpg' },
      { name: 'Cable Tricep Pushdowns',  muscle: 'Triceps',   sets: 3, reps: '12-15', tempo: '3-0-1-0', rest: '30 sec', imgId: 'Reverse_Grip_Triceps_Pushdown/0.jpg' },
    ]
  },
  6: {
    name: 'Lower B', focus: 'Hypertrophy',
    exercises: [
      { name: 'Deadlift',               muscle: 'Full Body',  sets: 4, reps: '6-8',   tempo: '3-0-1-0', rest: '30 sec', imgId: 'Barbell_Deadlift/0.jpg' },
      { name: 'Bulgarian Split Squats', muscle: 'Glutes',     sets: 3, reps: '10-12', tempo: '3-0-1-0', rest: '30 sec', imgId: 'Split_Squat_with_Dumbbells/0.jpg' },
      { name: 'Leg Curls',              muscle: 'Hamstrings', sets: 3, reps: '12-15', tempo: '3-0-1-0', rest: '30 sec', imgId: 'Lying_Leg_Curls/0.jpg' },
      { name: 'Leg Press',              muscle: 'Quads',      sets: 3, reps: '15-20', tempo: '2-0-1-0', rest: '30 sec', imgId: 'Leg_Press/0.jpg' },
      { name: 'Calf Raises',            muscle: 'Calves',     sets: 4, reps: '15-20', tempo: '2-1-1-1', rest: '30 sec', imgId: 'Standing_Calf_Raises/0.jpg' },
      { name: 'Hanging Leg Raises',     muscle: 'Core',       sets: 3, reps: '12-15', tempo: '2-0-1-0', rest: '30 sec', imgId: 'Hanging_Leg_Raise/0.jpg' },
      { name: 'Russian Twists',         muscle: 'Core',       sets: 3, reps: '20-30', tempo: '1-0-1-0', rest: '30 sec', imgId: 'Cable_Russian_Twists/0.jpg' },
    ]
  }
};

const IMG_BASE = 'https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/';
// imgId values are full relative paths: folder/0.jpg
const MUSCLE_ICONS = {
  'Chest':'ğŸ’ª','Back':'ğŸ”™','Shoulders':'ğŸ‹ï¸','Biceps':'ğŸ’ª','Triceps':'ğŸ’ª',
  'Quads':'ğŸ¦µ','Hamstrings':'ğŸ¦µ','Glutes':'ğŸ‘','Calves':'ğŸ¦¶',
  'Core':'âš¡','Rear Delt':'ğŸ¯','Full Body':'ğŸ”¥'
};

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const today    = new Date();
const todayStr = today.toISOString().split('T')[0];
const todayDow = today.getDay();

let selectedDow = todayDow;
let workout     = WORKOUTS[selectedDow] || null;
let currentUser = null;
let allLogs     = [];
const extraSets = {};

const WORKOUT_DAYS = [
  { dow: 1, short: 'Mon', label: 'Upper A' },
  { dow: 2, short: 'Tue', label: 'Lower A' },
  { dow: 4, short: 'Thu', label: 'Upper B' },
  { dow: 6, short: 'Sat', label: 'Lower B' },
];

function renderDaySelector() {
  const el = document.getElementById('daySelector');
  if (!el) return;
  el.innerHTML = WORKOUT_DAYS.map(d => `
    <button class="day-pill ${d.dow === selectedDow ? 'selected' : ''} ${d.dow === todayDow ? 'is-today' : ''}"
      onclick="selectWorkout(${d.dow})">
      ${d.label}<small>${d.short}${d.dow === todayDow ? ' Â· Today' : ''}</small>
    </button>`).join('');
}

function selectWorkout(dow) {
  selectedDow = dow;
  workout = WORKOUTS[dow] || null;
  renderDaySelector();
  renderToday();
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    await loadLogs();
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('signin-screen').style.display  = 'none';
    document.getElementById('app').style.display = 'block';
    renderDaySelector();
    renderToday();
  } else {
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('signin-screen').style.display  = 'flex';
    document.getElementById('app').style.display = 'none';
  }
});

function signIn() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => {
    // Fallback to redirect on mobile if popup blocked
    auth.signInWithRedirect(provider);
  });
}

function signOut() {
  auth.signOut();
}

// â”€â”€ Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function userLogs() {
  return db.collection('users').doc(currentUser.uid).collection('logs');
}

async function loadLogs() {
  const snapshot = await userLogs().get();
  allLogs = snapshot.docs.map(d => ({ _id: d.id, ...d.data() }));

  // Migrate any existing localStorage logs
  const local = JSON.parse(localStorage.getItem('gymLogs') || '[]');
  if (local.length > 0) {
    for (const log of local) {
      const exists = allLogs.some(l =>
        l.date === log.date && l.exercise === log.exercise && l.setIdx === log.setIdx
      );
      if (!exists) {
        const ref = await userLogs().add(log);
        allLogs.push({ _id: ref.id, ...log });
      }
    }
    localStorage.removeItem('gymLogs');
  }
}

function getLogs() { return allLogs; }

async function logSet(exercise, setIdx, weight, reps) {
  // Remove existing entry for this exercise+set+today
  const existing = allLogs.find(l =>
    l.date === todayStr && l.exercise === exercise && l.setIdx === setIdx
  );
  if (existing) {
    await userLogs().doc(existing._id).delete();
    allLogs = allLogs.filter(l => l._id !== existing._id);
  }
  // Add new entry
  const entry = {
    date: todayStr,
    workout: workout?.name || '',
    exercise,
    setIdx,
    weight: parseFloat(weight) || 0,
    reps: parseInt(reps) || 0,
    ts: Date.now()
  };
  const ref = await userLogs().add(entry);
  allLogs.push({ _id: ref.id, ...entry });
  showSyncToast();
}

function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('open');
}

function showSyncToast() {
  const t = document.getElementById('syncToast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// â”€â”€ Derived helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPrevBest(exerciseName) {
  const logs = getLogs()
    .filter(l => l.exercise === exerciseName && l.date !== todayStr && l.weight > 0)
    .sort((a, b) => b.date.localeCompare(a.date));
  if (!logs.length) return null;
  const latestDate = logs[0].date;
  const latestLogs = logs.filter(l => l.date === latestDate);
  const maxWeight  = Math.max(...latestLogs.map(l => l.weight));
  return { date: latestDate, weight: maxWeight };
}

function getTodayLogs(exerciseName) {
  return getLogs().filter(l => l.date === todayStr && l.exercise === exerciseName);
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + tab).classList.add('active');
  document.getElementById('nav-' + tab).classList.add('active');
  if (tab === 'history') renderHistory();
}

// â”€â”€ Render today â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderToday() {
  const dateStr = today.toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'long' });
  document.getElementById('todayDate').textContent = dateStr;

  if (!workout) {
    document.getElementById('workoutTitle').textContent = 'Rest Day';
    document.getElementById('workoutBadge').style.display = 'none';
    document.getElementById('todayContent').innerHTML = `
      <div class="rest-screen">
        <div class="emoji">ğŸ˜´</div>
        <h2>Recovery Day</h2>
        <p>Rest is where the gains happen.<br>Eat well, sleep well, come back stronger.</p>
      </div>`;
    return;
  }

  document.getElementById('workoutTitle').textContent = workout.name;
  document.getElementById('workoutBadge').textContent = workout.focus;

  const totalSets = workout.exercises.reduce((s, e) => s + e.sets, 0);
  let html = `
    <div class="summary-bar">
      <div class="summary-stat"><div class="val">${workout.exercises.length}</div><div class="lbl">Exercises</div></div>
      <div class="summary-stat"><div class="val">${totalSets}</div><div class="lbl">Total Sets</div></div>
      <div class="summary-stat"><div class="val">45-60</div><div class="lbl">Minutes</div></div>
    </div>`;

  workout.exercises.forEach((ex, exIdx) => {
    const prev        = getPrevBest(ex.name);
    const todayLogged = getTodayLogs(ex.name);
    const icon        = MUSCLE_ICONS[ex.muscle] || 'ğŸ’ª';
    const progressPct = Math.round((todayLogged.length / ex.sets) * 100);

    let setRowsHtml = '';
    for (let s = 0; s < ex.sets; s++) {
      const logged = todayLogged.find(l => l.setIdx === s);
      const isDone = !!logged;
      setRowsHtml += `
        <div class="set-row" id="setrow-${exIdx}-${s}">
          <div class="set-num">S${s+1}</div>
          <input class="set-input" type="number" inputmode="decimal" placeholder="kg"
            id="w-${exIdx}-${s}" value="${logged ? logged.weight : ''}">
          <input class="set-input" type="number" inputmode="numeric" placeholder="reps"
            id="r-${exIdx}-${s}" value="${logged ? logged.reps : ''}">
          <button class="set-done-btn ${isDone ? 'logged' : ''}" id="btn-${exIdx}-${s}"
            onclick="logSetUI(${exIdx}, ${s}, '${ex.name}')">
            ${isDone ? 'âœ“' : 'â—‹'}
          </button>
          <button class="set-del-btn" onclick="removeSetUI('${ex.name}', ${s}, 'setrow-${exIdx}-${s}', ${exIdx})">Ã—</button>
        </div>`;
    }

    html += `
      <div class="exercise-card">
        <img class="exercise-img" src="${IMG_BASE}${ex.imgId}" alt="${ex.name}"
          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
          onclick="openLightbox(this.src)"
        <div class="exercise-img-placeholder" style="display:none">${icon}</div>
        <div class="exercise-body">
          <div class="exercise-header">
            <div class="exercise-name">${ex.name}</div>
            <div class="muscle-badge">${ex.muscle}</div>
          </div>
          <div class="exercise-meta">
            <div class="meta-chip"><span>${ex.sets}</span> sets</div>
            <div class="meta-chip"><span>${ex.reps}</span> reps</div>
            <div class="meta-chip">Tempo <span>${ex.tempo}</span></div>
            <div class="meta-chip">Rest <span>${ex.rest}</span></div>
          </div>
          ${prev
            ? `<div class="prev-best"><span>Previous best:</span><span class="val">${prev.weight} kg</span><span>on ${new Date(prev.date + 'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</span></div>`
            : `<div class="prev-best" style="color:var(--sub)">No previous logs â€” first time! ğŸ”¥</div>`}
          <div class="sets-header">
            <span>Set</span><span>Weight</span><span>Reps</span><span></span><span></span>
          </div>
          ${setRowsHtml}
          <button class="add-set-btn" onclick="addSet(${exIdx}, '${ex.name}')">+ Add Set</button>
          <div class="progress-bar-wrap">
            <div class="progress-bar-label">
              <span>Progress</span>
              <span id="prog-label-${exIdx}">${todayLogged.length}/${ex.sets} sets</span>
            </div>
            <div class="progress-bar-track">
              <div class="progress-bar-fill" id="prog-${exIdx}" style="width:${progressPct}%"></div>
            </div>
          </div>
        </div>
      </div>`;
  });

  document.getElementById('todayContent').innerHTML = html;
}

// â”€â”€ Set logging UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function logSetUI(exIdx, setIdx, exerciseName) {
  const weight = document.getElementById(`w-${exIdx}-${setIdx}`).value;
  const reps   = document.getElementById(`r-${exIdx}-${setIdx}`).value;
  if (!weight && !reps) return;

  const btn = document.getElementById(`btn-${exIdx}-${setIdx}`);
  btn.textContent = 'â€¦';

  await logSet(exerciseName, setIdx, weight || 0, reps || 0);

  btn.classList.add('logged');
  btn.textContent = 'âœ“';
  updateProgress(exIdx, exerciseName);
}

function updateProgress(exIdx, exerciseName) {
  const ex     = workout.exercises[exIdx];
  const logged = getTodayLogs(exerciseName);
  const pct    = Math.round((logged.length / ex.sets) * 100);
  const bar    = document.getElementById(`prog-${exIdx}`);
  const lbl    = document.getElementById(`prog-label-${exIdx}`);
  if (bar) bar.style.width = pct + '%';
  if (lbl) lbl.textContent = `${logged.length}/${ex.sets} sets`;
}

function addSet(exIdx, exerciseName) {
  if (!extraSets[exIdx]) extraSets[exIdx] = 0;
  extraSets[exIdx]++;
  const ex        = workout.exercises[exIdx];
  const newSetIdx = ex.sets + extraSets[exIdx] - 1;
  const addBtn    = document.querySelector(`#view-today .exercise-card:nth-child(${exIdx + 2}) .add-set-btn`);

  const rowId = `setrow-${exIdx}-${newSetIdx}`;
  const row = document.createElement('div');
  row.className = 'set-row';
  row.id = rowId;
  row.innerHTML = `
    <div class="set-num">S${newSetIdx + 1}</div>
    <input class="set-input" type="number" inputmode="decimal" placeholder="kg" id="w-${exIdx}-${newSetIdx}">
    <input class="set-input" type="number" inputmode="numeric" placeholder="reps" id="r-${exIdx}-${newSetIdx}">
    <button class="set-done-btn" id="btn-${exIdx}-${newSetIdx}"
      onclick="logSetUI(${exIdx}, ${newSetIdx}, '${exerciseName}')">â—‹</button>
    <button class="set-del-btn" onclick="removeSetUI('${exerciseName}', ${newSetIdx}, '${rowId}', ${exIdx})">Ã—</button>`;
  if (addBtn) addBtn.parentNode.insertBefore(row, addBtn);
}

// â”€â”€ Remove set â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function removeSetUI(exerciseName, setIdx, rowId, exIdx) {
  // Delete from Firestore if it was logged
  const existing = allLogs.find(l =>
    l.date === todayStr && l.exercise === exerciseName && l.setIdx === setIdx
  );
  if (existing) {
    await userLogs().doc(existing._id).delete();
    allLogs = allLogs.filter(l => l._id !== existing._id);
  }
  // Remove row from DOM
  const row = document.getElementById(rowId);
  if (row) row.remove();
  // Update progress bar
  updateProgress(exIdx, exerciseName);
}

// â”€â”€ Render history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistory() {
  const logs      = getLogs();
  const container = document.getElementById('historyContent');

  if (!logs.length) {
    container.innerHTML = `
      <div class="history-empty">
        <div class="emoji">ğŸ“‹</div>
        <p>No workouts logged yet.<br>Complete your first session to see history here.</p>
      </div>`;
    return;
  }

  const byDate = {};
  logs.forEach(l => {
    if (!byDate[l.date]) byDate[l.date] = {};
    if (!byDate[l.date][l.exercise]) byDate[l.date][l.exercise] = [];
    byDate[l.date][l.exercise].push(l);
  });

  const dates = Object.keys(byDate).sort((a,b) => b.localeCompare(a));
  let html = '';

  dates.forEach(date => {
    const d          = new Date(date + 'T12:00:00');
    const dateLabel  = d.toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
    const exercises  = byDate[date];
    const exNames    = Object.keys(exercises);
    const workoutName = logs.find(l => l.date === date)?.workout || 'Workout';
    const totalSets  = Object.values(exercises).reduce((s, sets) => s + sets.length, 0);

    const exerciseDetails = exNames.map(ex => {
      const sets    = exercises[ex].sort((a,b) => a.setIdx - b.setIdx);
      const setRows = sets.map(s => `
        <div class="session-set-row">
          <span class="set-label">Set ${s.setIdx + 1}</span>
          <span class="set-data">${s.weight > 0 ? s.weight + ' kg' : 'â€”'} Ã— ${s.reps > 0 ? s.reps + ' reps' : 'â€”'}</span>
        </div>`).join('');
      return `
        <div class="session-exercise">
          <div class="session-exercise-name">${ex}</div>
          <div class="session-sets">${setRows}</div>
        </div>`;
    }).join('');

    html += `
      <div class="session-group">
        <div class="session-date">${dateLabel}</div>
        <div class="session-card">
          <div class="session-card-header" onclick="toggleSession(this)">
            <div>
              <h3>${workoutName}</h3>
              <div class="session-summary">${exNames.length} exercises Â· ${totalSets} sets logged</div>
            </div>
            <span class="session-chevron">â€º</span>
          </div>
          <div class="session-detail">${exerciseDetails}</div>
        </div>
      </div>`;
  });

  container.innerHTML = html;
}

function toggleSession(header) {
  header.querySelector('.session-chevron').classList.toggle('open');
  header.nextElementSibling.classList.toggle('open');
}
</script>
</body>
</html>
